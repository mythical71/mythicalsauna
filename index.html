<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Mythical Sauna Breathing</title>
  <meta name="theme-color" content="#0f172a" />
  <style>
    :root{
      --bg:#0b1020; --card:#121a33; --accent:#22d3ee; --accent2:#a78bfa; --text:#e6f0ff; --muted:#90a4c8;
      --progress:0%; --footer-h:92px; --dim:0.5;
      --glow: rgba(56,189,248,0.35);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; min-height:100svh; overflow-x:hidden;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,"Helvetica Neue",Arial;
      color:var(--text); background:var(--bg);
    }
    #bgVideo{position:fixed; inset:0; width:100%; height:100%; object-fit:cover; z-index:-2; background:#000; pointer-events:none;
      transition: opacity .35s ease; opacity:1;
    }
    body::before{content:""; position:fixed; inset:0; background:rgba(0,0,0,var(--dim)); z-index:-1; pointer-events:none;}
    #themeGlow{position:fixed; inset:0; z-index:-1; pointer-events:none; opacity:0;}
    #themeGlow.glow-active{ animation: glowPulse 700ms ease-in-out forwards; }
    @keyframes glowPulse{
      0%{ opacity:0; background:radial-gradient(120% 120% at 50% 50%, transparent 0%, transparent 40%, var(--glow) 60%, transparent 80%); filter: blur(0px); }
      35%{ opacity:.45; background:radial-gradient(120% 120% at 50% 50%, transparent 0, var(--glow) 45%, var(--glow) 62%, transparent 82%); filter: blur(2px);}
      60%{ opacity:.25; background:radial-gradient(120% 120% at 50% 50%, transparent 0, var(--glow) 35%, var(--glow) 55%, transparent 78%); filter: blur(1px);}
      100%{ opacity:0; background:radial-gradient(120% 120% at 50% 50%, transparent 0%, transparent 40%, var(--glow) 60%, transparent 80%); filter: blur(0px); }
    }
    .app{max-width:900px; margin:0 auto; padding:16px; padding-bottom:calc(var(--footer-h) + env(safe-area-inset-bottom) + 8px); position:relative; z-index:0}
    header{display:flex; align-items:center; justify-content:space-between; gap:12px; padding:10px 0}
    header h1{font-size:22px; margin:0; letter-spacing:.5px}
    .actions{display:flex; gap:8px; flex-wrap:wrap}
    button{appearance:none; border:0; background:linear-gradient(180deg,#1f2a4a,#10162b); color:var(--text);
      padding:10px 14px; border-radius:12px; font-weight:600; cursor:pointer;
      box-shadow:0 6px 18px rgba(0,0,0,.35), inset 0 0 0 1px rgba(255,255,255,.06);
      transition: transform .06s ease, box-shadow .12s ease, filter .12s ease;
    }
    button:disabled{opacity:.55; cursor:not-allowed}
    .btn-ghost{background:transparent; border:1px solid rgba(255,255,255,.12)}
    .grid{display:grid; gap:12px}
    .card{background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.08); border-radius:16px; padding:14px;
      box-shadow:0 20px 40px rgba(0,0,0,.25)
    }
    .row{display:flex; align-items:center; justify-content:space-between; gap:12px}
    .label{font-size:12px; color:var(--muted); letter-spacing:.3px}
    .value{font-weight:700}
    input[type="range"]{width:100%}
    input[type="number"]{width:90px; padding:8px; border-radius:8px; border:1px solid rgba(255,255,255,.15);
      background:rgba(255,255,255,.06); color:var(--text)
    }
    .circle-wrap{display:grid; place-items:center; margin:18px 0}
    .circle{width:min(88vw,68svh); height:min(88vw,68svh); border-radius:50%;
      background: radial-gradient(closest-side, rgba(34,211,238,.25), rgba(167,139,250,.12) 60%, transparent 61%),
                  conic-gradient(from 270deg, var(--accent) var(--progress), rgba(255,255,255,.06) 0%);
      display:grid; place-items:center; position:relative; transition:filter .3s ease;
      box-shadow: 0 0 0 1px rgba(255,255,255,.08), 0 12px 60px rgba(34,211,238,.15), inset 0 0 80px rgba(167,139,250,.12);
    }
    .circle-inner{width:85%; height:85%; border-radius:50%;
      background: radial-gradient(120% 100% at 50% 0%, rgba(167,139,250,.16), rgba(34,211,238,.08));
      display:grid; place-items:center; text-align:center; padding:12px;
    }
    .phase{font-size:14px; color:var(--muted); letter-spacing:.25px}
    .count{font-size:clamp(40px,10vw,72px); font-weight:900; line-height:1.05}
    .hint{font-size:12px; color:var(--muted)}
    .chips{display:flex; flex-wrap:wrap; gap:8px}
    .chip.active{outline:2px solid var(--accent)}
    .chip{padding:8px 12px; border-radius:999px; background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.1); cursor:pointer; font-weight:600}
    .twocol{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    @media (max-width: 900px){ .twocol{grid-template-columns:1fr} .circle-wrap{margin:8px 0} }
    .footer{position:fixed; left:0; right:0; bottom:0; height:var(--footer-h);
      padding:12px 16px; padding-bottom:calc(12px + env(safe-area-inset-bottom));
      backdrop-filter: blur(10px);
      background:linear-gradient(180deg, rgba(2,6,23,0), rgba(2,6,23,.85));
      border-top:1px solid rgba(255,255,255,.08); display:flex; align-items:center; gap:12px;
      z-index: 2;
    }
    .grow{flex:1}
    #debug{position:fixed;left:10px;bottom:calc(var(--footer-h) + 12px);font:12px/1.2 system-ui;background:rgba(0,0,0,.35);border:1px solid rgba(255,255,255,.2);padding:6px 8px;border-radius:10px;max-width:min(90vw,420px);white-space:pre-wrap;z-index:3;display:none}
    #debugToggle{position:fixed;left:10px;bottom:10px;z-index:4}
  </style>
</head>
<body>
  <video id="bgVideo" autoplay muted loop playsinline>
    <source id="bgSrcWebm" src="" type="video/webm">
    <source id="bgSrcMp4"  src="" type="video/mp4">
  </video>
  <div id="themeGlow"></div>

  <div id="debug"></div>
  <button id="debugToggle" class="btn-ghost">Debug</button>

  <div class="app">
    <header>
      <h1>🧖 Sauna Breathing</h1>
      <div class="actions">
        <button id="btnFullscreen" class="btn-ghost" title="Fullscreen">⤢</button>
      </div>
    </header>

    <section class="card circle-wrap">
      <div class="circle" id="circle">
        <div class="circle-inner">
          <div class="phase" id="phase">Ready</div>
          <div class="count" id="counter">0</div>
          <div class="hint" id="roundsHint">Rounds: 0 • Cycle: 0</div>
        </div>
      </div>
    </section>

    <div class="card">
      <div class="chips" id="presets">
        <button class="chip" data-preset='{"name":"Box 4-4-4-4","inhale":4,"hold1":4,"exhale":4,"hold2":4,"cycles":12,"rounds":3}'>Box 4-4-4-4</button>
        <button class="chip" data-preset='{"name":"4-7-8","inhale":4,"hold1":7,"exhale":8,"hold2":0,"cycles":8,"rounds":3}'>4-7-8</button>
        <button class="chip" data-preset='{"name":"Sauna Calm","inhale":5,"hold1":0,"exhale":7,"hold2":0,"cycles":12,"rounds":3}'>Sauna Calm</button>
        <button class="chip" data-preset='{"name":"Wim Hof (guided)","inhale":2,"hold1":0,"exhale":2,"hold2":0,"cycles":30,"rounds":3}'>Wim Hof (guided)</button>
        <button class="chip" data-preset='{"name":"Custom"}'>Custom</button>
      </div>
    </div>

    <section class="grid">
      <div class="twocol">
        <div class="card grid">
          <div class="row"><span class="label">Inhale (sec)</span><span class="value" id="vIn">5</span></div>
          <input class="range" id="rIn" type="range" min="1" max="12" value="5" />
          <div class="row"><span class="label">Hold after inhale (sec)</span><span class="value" id="vH1">0</span></div>
          <input class="range" id="rH1" type="range" min="0" max="20" value="0" />
          <div class="row"><span class="label">Exhale (sec)</span><span class="value" id="vEx">7</span></div>
          <input class="range" id="rEx" type="range" min="2" max="20" value="7" />
          <div class="row"><span class="label">Hold after exhale (sec)</span><span class="value" id="vH2">0</span></div>
          <input class="range" id="rH2" type="range" min="0" max="20" value="0" />
          <div class="row">
            <label class="label">Cycles per round</label>
            <input id="cycles" type="number" min="1" max="120" value="12"/>
            <label class="label">Rounds</label>
            <input id="rounds" type="number" min="1" max="20" value="3"/>
          </div>
        </div>

        <div class="card grid">
          <div class="row">
            <span class="label">Theme</span>
            <select id="selTheme">
              <option value="none">None</option>
              <option value="ocean">🌊 Ocean</option>
              <option value="fireplace">🔥 Fireplace</option>
              <option value="waterfall">💦 Waterfall</option>
            </select>
          </div>
          <div class="row">
            <span class="label">Animated background</span>
            <label><input id="chkVideo" type="checkbox" checked> On</label>
          </div>
          <div class="row">
            <span class="label">Background dim</span>
            <input id="dimSlider" type="range" min="0" max="0.85" step="0.01" value="0.5" class="range">
          </div>
          <hr style="opacity:.15; width:100%">

          <div class="row">
            <span class="label">Scene audio (use video sound)</span>
            <label><input id="chkSceneAudio" type="checkbox" checked> On</label>
          </div>
          <div class="row">
            <span class="label">Scene volume</span>
            <input id="volScene" type="range" min="0" max="1" step="0.01" value="0.5" class="range">
          </div>

          <div class="row">
            <span class="label">Ambient noise</span>
            <label><input id="chkAmbient" type="checkbox"> On</label>
          </div>
          <div class="row">
            <span class="label">Ambient volume</span>
            <input id="volAmbient" type="range" min="0" max="1" step="0.01" value="0.25" class="range">
          </div>

          <div class="row">
            <span class="label">Cue beeps</span>
            <label><input id="chkBeeps" type="checkbox" checked> On</label>
          </div>
          <div class="row">
            <span class="label">Voice counts</span>
            <label><input id="chkVoice" type="checkbox"> On</label>
          </div>
          <div class="row">
            <span class="label">Vibrate on phase</span>
            <label><input id="chkVibrate" type="checkbox" checked> On</label>
          </div>
          <div class="row">
            <span class="label">Fireplace crackle (if no audio)</span>
            <label><input id="chkCrackle" type="checkbox" checked> On</label>
          </div>
        </div>
      </div>

      <div class="card">
        <h3 style="margin:6px 0 12px 0">⏱ Sauna Timer</h3>
        <div class="row" style="flex-wrap:wrap; gap:12px">
          <div><span class="label">Duration (min)</span><br><input id="timerMinutes" type="number" min="1" max="60" value="12"></div>
          <div><span class="label">Sets</span><br><input id="timerSets" type="number" min="1" max="20" value="3"></div>
          <div><span class="label">Rest between (min)</span><br><input id="timerRest" type="number" min="0" max="20" value="2"></div>
          <div class="row" style="gap:8px; margin-left:auto">
            <button id="btnTimerStart">Start Timer</button>
            <button id="btnTimerPause" disabled>Pause</button>
            <button id="btnTimerStop" disabled>Stop</button>
          </div>
        </div>
      </div>
    </section>
  </div>

  <div class="footer row">
    <div class="row grow" style="gap:8px">
      <button id="btnStart" aria-pressed="false">▶ Start</button>
      <button id="btnPause" disabled>⏸️ Pause</button>
      <button id="btnStop" disabled>■ Stop</button>
    </div>
    <div class="row" style="gap:8px">
      <button id="btnReset" class="btn-ghost">Reset</button>
    </div>
  </div>

  <script>
  (function(){
    'use strict';
    const $ = s => document.querySelector(s);
    const els = {
      selTheme: $('#selTheme'), chkVideo: $('#chkVideo'), dimSlider: $('#dimSlider'),
      chkSceneAudio: $('#chkSceneAudio'), volScene: $('#volScene'),
      chkAmbient: $('#chkAmbient'), volAmbient: $('#volAmbient'),
      chkCrackle: $('#chkCrackle'),
      bgVideo: $('#bgVideo'), bgSrcWebm: $('#bgSrcWebm'), bgSrcMp4: $('#bgSrcMp4'),
      glow: $('#themeGlow'),
      debug: $('#debug'), debugToggle: $('#debugToggle')
    };

    // Minimal other logic kept out for brevity (breathing, timer, cues) — this build focuses on theme switching stability
    // For your app, swap this whole file as index.html to test themes. If good, I'll merge back into full app file.

    // Debug helpers
    let debugOn=false;
    function log(msg){ if(!debugOn) return; els.debug.textContent += (els.debug.textContent? '\\n' : '') + msg; }
    els.debugToggle.addEventListener('click', ()=>{
      debugOn = !debugOn;
      els.debug.style.display = debugOn ? 'block' : 'none';
      els.debugToggle.textContent = debugOn ? 'Debug ON' : 'Debug';
      if (debugOn) els.debug.textContent='';
    });

    // Files
    const THEME_MEDIA = {
      ocean:     { webm: 'media/ocean.webm',     mp4: 'media/ocean.mp4',     glow:'rgba(56,189,248,0.35)'  },
      fireplace: { webm: 'media/fireplace.webm', mp4: 'media/fireplace.mp4', glow:'rgba(251,146,60,0.35)' },
      waterfall: { webm: 'media/waterfall.webm', mp4: 'media/waterfall.mp4', glow:'rgba(45,212,191,0.35)' }
    };

    // Audio
    function ensurePlay(){ try{ els.bgVideo.play(); }catch{} }

    // Ramps
    function rampVolume(el, to, ms){
      return new Promise(resolve=>{
        const from = el.volume;
        const start = performance.now();
        function step(now){
          const t = Math.min(1, (now - start)/ms);
          el.volume = from + (to - from) * t;
          if (t < 1) requestAnimationFrame(step); else resolve();
        }
        requestAnimationFrame(step);
      });
    }

    let loading=false;
    async function applyTheme(){
      if(loading) return;
      loading=true;
      try {
        const theme = els.selTheme.value;
        if(!els.chkVideo.checked || theme==='none'){
          els.bgVideo.pause(); els.bgVideo.style.display='none'; log('Video off or theme none'); return;
        }
        const m = THEME_MEDIA[theme];
        if(!m){ els.bgVideo.pause(); els.bgVideo.style.display='none'; log('No mapping'); return; }

        document.documentElement.style.setProperty('--glow', m.glow || 'rgba(56,189,248,0.35)');
        els.glow.classList.remove('glow-active'); void els.glow.offsetWidth;
        els.glow.classList.add('glow-active');

        els.bgVideo.style.opacity=0;
        await new Promise(r=>setTimeout(r, 300));

        // Try WEBM first, then MP4 fallback, with error handlers
        const vtag='?v=22';
        let triedMp4=false;
        let resolved=false;

        function cleanup(){
          els.bgVideo.removeEventListener('canplay', onCanPlay);
          els.bgVideo.removeEventListener('error', onVideoError);
          els.bgSrcWebm.removeEventListener('error', onSourceError);
          els.bgSrcMp4.removeEventListener('error', onSourceError);
        }

        const onCanPlay = async () => {
          if(resolved) return;
          resolved=true; cleanup();
          els.bgVideo.style.display='';
          ensurePlay();
          try{ await rampVolume(els.bgVideo, 0.5, 500); }catch{ els.bgVideo.volume=0.5; }
          els.bgVideo.style.opacity=1;
          log('canplay -> success');
        };
        const onVideoError = () => {
          log('video error');
          if(!triedMp4){
            triedMp4=true;
            els.bgSrcWebm.src=''; els.bgSrcMp4.src = m.mp4 + vtag;
            els.bgVideo.load(); ensurePlay();
          } else {
            cleanup();
            log('both sources failed');
          }
        };
        const onSourceError = (e) => {
          log('source error ' + (e.target===els.bgSrcWebm?'webm':'mp4'));
          if(e.target===els.bgSrcWebm && !triedMp4){
            triedMp4=true;
            els.bgSrcWebm.src=''; els.bgSrcMp4.src = m.mp4 + vtag;
            els.bgVideo.load(); ensurePlay();
          }
        };

        els.bgVideo.addEventListener('canplay', onCanPlay);
        els.bgVideo.addEventListener('error', onVideoError);
        els.bgSrcWebm.addEventListener('error', onSourceError);
        els.bgSrcMp4.addEventListener('error', onSourceError);

        els.bgSrcWebm.src = m.webm + vtag;
        els.bgSrcMp4.src  = m.mp4  + vtag;
        els.bgVideo.muted=false;
        els.bgVideo.volume=0.0;
        els.bgVideo.load(); ensurePlay();

        // Safety timeout: if nothing in 2s, try mp4-only
        setTimeout(()=>{
          if(!resolved && !triedMp4){
            log('timeout -> try mp4 only');
            triedMp4=true;
            els.bgSrcWebm.src=''; els.bgSrcMp4.src = m.mp4 + vtag;
            els.bgVideo.load(); ensurePlay();
          }
        }, 2000);
      } finally {
        // Give the swap a moment before allowing another change
        setTimeout(()=>{ loading=false; }, 400);
      }
    }

    // Prefs (minimal to keep focus)
    function loadPrefs(){
      const stored = localStorage.getItem('ms.theme') || 'ocean';
      $('#selTheme').value = stored;
      document.documentElement.style.setProperty('--dim', (localStorage.getItem('ms.dim') ?? '0.5'));
    }
    function saveTheme(){ try{ localStorage.setItem('ms.theme', els.selTheme.value); }catch{} }

    // Bind
    loadPrefs();
    applyTheme();
    els.selTheme.addEventListener('change', ()=>{ saveTheme(); applyTheme(); });
    els.chkVideo.addEventListener('change', applyTheme);
    $('#debugToggle').addEventListener('click', ()=>{}); // already handled earlier
  })();
  </script>
</body>
</html>
