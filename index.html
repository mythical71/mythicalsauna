<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Sauna Breathing</title>
  <meta name="theme-color" content="#0f172a" />
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="apple-touch-icon" href="icons/icon-192.png">
  <link rel="icon" sizes="192x192" href="icons/icon-192.png">
  <link rel="icon" sizes="512x512" href="icons/icon-512.png">
  <style>
    :root{
      --bg:#0b1020; --card:#121a33; --accent:#22d3ee; --accent2:#a78bfa; --text:#e6f0ff; --muted:#90a4c8;
      --progress:0%; --footer-h:92px; --dim:0.45; /* stronger default dim */
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; min-height:100svh; overflow-x:hidden;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,"Helvetica Neue",Arial;
      color:var(--text); background:var(--bg);
    }
    /* Background video lives behind everything */
    .app{max-width:900px; margin:0 auto; padding:16px;
         padding-bottom:calc(var(--footer-h) + env(safe-area-inset-bottom) + 8px);
         position:relative; z-index:1}
    /* Adjustable dim so text pops over video */
    body::before{content:""; position:fixed; inset:0; background:rgba(0,0,0,var(--dim)); z-index:0}
    header{display:flex; align-items:center; justify-content:space-between; gap:12px; padding:12px 0}
    header h1{font-size:22px; margin:0; letter-spacing:.5px}
    .actions{display:flex; gap:8px; flex-wrap:wrap}
    button,.btn{appearance:none; border:0; background:linear-gradient(180deg,#1f2a4a,#10162b); color:var(--text);
      padding:10px 14px; border-radius:12px; font-weight:600; cursor:pointer;
      box-shadow:0 6px 18px rgba(0,0,0,.35), inset 0 0 0 1px rgba(255,255,255,.06);
    }
    button:disabled{opacity:.55; cursor:not-allowed}
    .btn-ghost{background:transparent; border:1px solid rgba(255,255,255,.12)}
    .grid{display:grid; gap:12px}
    .card{background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.08); border-radius:16px; padding:14px;
      box-shadow:0 20px 40px rgba(0,0,0,.25)
    }
    .row{display:flex; align-items:center; justify-content:space-between; gap:12px}
    .label{font-size:12px; color:var(--muted); letter-spacing:.3px}
    .value{font-weight:700}
    input[type="range"]{width:100%}
    input[type="number"]{width:90px; padding:8px; border-radius:8px; border:1px solid rgba(255,255,255,.15);
      background:rgba(255,255,255,.06); color:var(--text)
    }
    .circle-wrap{display:grid; place-items:center; margin:18px 0}
    .circle{width:min(88vw,68svh); height:min(88vw,68svh); border-radius:50%;
      background: radial-gradient(closest-side, rgba(34,211,238,.25), rgba(167,139,250,.12) 60%, transparent 61%),
                  conic-gradient(from 270deg, var(--accent) var(--progress), rgba(255,255,255,.06) 0%);
      display:grid; place-items:center; position:relative; transition:filter .3s ease;
      box-shadow: 0 0 0 1px rgba(255,255,255,.08), 0 12px 60px rgba(34,211,238,.15), inset 0 0 80px rgba(167,139,250,.12);
    }
    .circle-inner{width:85%; height:85%; border-radius:50%;
      background: radial-gradient(120% 100% at 50% 0%, rgba(167,139,250,.16), rgba(34,211,238,.08));
      display:grid; place-items:center; text-align:center; padding:12px;
    }
    .phase{font-size:14px; color:var(--muted); letter-spacing:.25px}
    .count{font-size:clamp(40px,10vw,72px); font-weight:900; line-height:1.05}
    .hint{font-size:12px; color:var(--muted)}
    .twocol{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    @media (max-width: 900px){ .twocol{grid-template-columns:1fr} .circle-wrap{margin:8px 0} }
    .footer{position:fixed; left:0; right:0; bottom:0; height:var(--footer-h);
      padding:12px 16px; padding-bottom:calc(12px + env(safe-area-inset-bottom));
      backdrop-filter: blur(10px);
      background:linear-gradient(180deg, rgba(2,6,23,0), rgba(2,6,23,.85));
      border-top:1px solid rgba(255,255,255,.08); display:flex; align-items:center; gap:12px;
    }
    .grow{flex:1} .small{font-size:12px} .hidden{display:none}
    .danger{background:linear-gradient(180deg,#3b1111,#220b0b); border:1px solid rgba(255,255,255,.06)}
    .accent{background:linear-gradient(180deg,#164e63,#0b3742)}
    .timer-pill{font-variant-numeric:tabular-nums; padding:6px 10px; border-radius:999px;
      background:rgba(20,184,166,.12); border:1px solid rgba(20,184,166,.35)
    }
  </style>
</head>
<body>
  <!-- Fullscreen animated background (sources set by JS) -->
  <video id="bgVideo" autoplay muted loop playsinline
         style="position:fixed; inset:0; width:100%; height:100%; object-fit:cover; z-index:-1; background:#000;">
    <source id="bgSrcWebm" src="" type="video/webm">
    <source id="bgSrcMp4"  src="" type="video/mp4">
  </video>

  <div class="app">
    <header>
      <h1>üßñ Sauna Breathing</h1>
      <div class="actions">
        <span id="timerStatus" class="timer-pill hidden">‚è± <strong id="timerMMSS">00:00</strong> <span id="timerSet">(Set 0/0)</span></span>
        <button id="btnFullscreen" class="btn-ghost" title="Fullscreen">‚§¢</button>
        <button id="btnWakeLock" class="btn-ghost" title="Keep Screen Awake">üîÜ</button>
        <button id="btnInstall" class="btn-ghost" title="Add to Home Screen" hidden>‚¨áÔ∏è Install</button>
      </div>
    </header>

    <section class="card circle-wrap">
      <div class="circle" id="circle">
        <div class="circle-inner">
          <div class="phase" id="phase">Ready</div>
          <div class="count" id="counter">0</div>
          <div class="hint" id="roundsHint">Rounds: 0 ‚Ä¢ Cycle: 0</div>
        </div>
      </div>
    </section>

    <section class="grid">
      <div class="twocol">
        <div class="card grid">
          <!-- Timing controls -->
          <div class="row"><span class="label">Inhale (sec)</span><span class="value" id="vIn">5</span></div>
          <input class="range" id="rIn" type="range" min="1" max="12" value="5" />
          <div class="row"><span class="label">Hold after inhale (sec)</span><span class="value" id="vH1">0</span></div>
          <input class="range" id="rH1" type="range" min="0" max="20" value="0" />
          <div class="row"><span class="label">Exhale (sec)</span><span class="value" id="vEx">7</span></div>
          <input class="range" id="rEx" type="range" min="2" max="20" value="7" />
          <div class="row"><span class="label">Hold after exhale (sec)</span><span class="value" id="vH2">0</span></div>
          <input class="range" id="rH2" type="range" min="0" max="20" value="0" />
          <div class="row">
            <label class="label">Cycles per round</label>
            <input id="cycles" type="number" min="1" max="120" value="12"/>
            <label class="label">Rounds</label>
            <input id="rounds" type="number" min="1" max="20" value="3"/>
          </div>
        </div>

        <div class="card grid">
          <!-- Audio & UX toggles -->
          <div class="row"><span class="label">Ambient sound</span><label><input id="chkAmbient" type="checkbox" checked> On</label></div>
          <div class="row"><span class="label">Ambient volume</span><input id="volAmbient" type="range" min="0" max="1" step="0.01" value="0.25" class="range"></div>
          <div class="row"><span class="label">Cue beeps</span><label><input id="chkBeeps" type="checkbox" checked> On</label></div>
          <div class="row"><span class="label">Voice counts</span><label><input id="chkVoice" type="checkbox"> On</label></div>
          <div class="row"><span class="label">Vibrate on phase</span><label><input id="chkVibrate" type="checkbox" checked> On</label></div>
          <div class="row">
            <span class="label">Theme</span>
            <select id="selTheme">
              <option value="none">None</option>
              <option value="ocean">üåä Ocean</option>
              <option value="fireplace">üî• Fireplace</option>
              <option value="waterfall">üí¶ Waterfall</option>
            </select>
          </div>
          <div class="row">
            <span class="label">Animated background</span>
            <label><input id="chkVideo" type="checkbox" checked> On</label>
          </div>
          <div class="row">
            <span class="label">Background dim</span>
            <input id="dimSlider" type="range" min="0" max="0.8" step="0.01" value="0.45" class="range">
          </div>
        </div>
      </div>

      <div class="card">
        <h3 style="margin:6px 0 12px 0">‚è± Sauna Timer</h3>
        <div class="row" style="flex-wrap:wrap; gap:12px">
          <div><span class="label">Duration (min)</span><br><input id="timerMinutes" type="number" min="1" max="60" value="12"></div>
          <div><span class="label">Sets</span><br><input id="timerSets" type="number" min="1" max="20" value="3"></div>
          <div><span class="label">Rest between (min)</span><br><input id="timerRest" type="number" min="0" max="20" value="2"></div>
          <div class="row" style="gap:8px; margin-left:auto">
            <button id="btnTimerStart" class="accent">Start Timer</button>
            <button id="btnTimerPause" disabled>Pause</button>
            <button id="btnTimerStop" class="danger" disabled>Stop</button>
          </div>
        </div>
        <div class="small" style="margin-top:8px; color:var(--muted)">Timer runs independently so you can breathe with guidance while it counts your sauna set. You‚Äôll hear a chime at each stage.</div>
      </div>

      <div id="safety" class="card"><strong>Safety:</strong> Sit down between sauna benches and avoid breath-holds if you feel light‚Äëheaded. Never use this app while driving.</div>
    </section>
  </div>

  <div class="footer row">
    <div class="row grow" style="gap:8px">
      <button id="btnStart" class="accent">‚ñ∂ Start</button>
      <button id="btnPause" disabled>‚è∏Ô∏è Pause</button>
      <button id="btnStop" class="danger" disabled>‚ñ† Stop</button>
    </div>
    <div class="row" style="gap:8px">
      <button id="btnReset" class="btn-ghost">Reset</button>
      <button id="btnBig" class="btn-ghost" title="Big numbers">üîç</button>
    </div>
  </div>

  <script>
  // --- elements ---
  const $ = sel => document.querySelector(sel);
  const els = {
    rIn: $('#rIn'), rH1: $('#rH1'), rEx: $('#rEx'), rH2: $('#rH2'),
    vIn: $('#vIn'), vH1: $('#vH1'), vEx: $('#vEx'), vH2: $('#vH2'),
    cycles: $('#cycles'), rounds: $('#rounds'),
    btnStart: $('#btnStart'), btnPause: $('#btnPause'), btnStop: $('#btnStop'), btnReset: $('#btnReset'),
    timerMinutes: $('#timerMinutes'), timerSets: $('#timerSets'), timerRest: $('#timerRest'),
    btnTimerStart: $('#btnTimerStart'), btnTimerPause: $('#btnTimerPause'), btnTimerStop: $('#btnTimerStop'),
    timerStatus: $('#timerStatus'), timerMMSS: $('#timerMMSS'), timerSet: $('#timerSet'),
    selTheme: $('#selTheme'), chkVideo: $('#chkVideo'), dimSlider: $('#dimSlider')
  };

  // --- breathing logic (compact) ---
  let running=false, paused=false, loopHandle=null, round=0, cycle=0, phaseIndex=0, phaseTimeLeft=0;
  const phasesBase=[{key:'inhale',label:'Inhale'},{key:'hold1',label:'Hold'},{key:'exhale',label:'Exhale'},{key:'hold2',label:'Hold'}];
  function updateVals(){ els.vIn.textContent=els.rIn.value; els.vH1.textContent=els.rH1.value; els.vEx.textContent=els.rEx.value; els.vH2.textContent=els.rH2.value; document.documentElement.style.setProperty('--progress','0%'); }
  [els.rIn,els.rH1,els.rEx,els.rH2].forEach(r=>r.addEventListener('input', updateVals));
  function totalPhaseSeconds(){ const arr=[+els.rIn.value,+els.rH1.value,+els.rEx.value,+els.rH2.value]; return arr.map((v,i)=>({dur:v,...phasesBase[i]})).filter(p=>p.dur>0||p.key==='inhale'||p.key==='exhale'); }
  function loop(){ if(!running) return; const seq=totalPhaseSeconds(); const phase=seq[phaseIndex % seq.length]; if(!paused){ phaseTimeLeft-=0.1; updateScreen(phase.label, Math.max(0, Math.ceil(phaseTimeLeft))); progressUpdate(); if(phaseTimeLeft<=0){ nextPhase(seq); } } loopHandle=setTimeout(loop,100); }
  function nextPhase(seq){ phaseIndex++; if(phaseIndex % seq.length===0){ cycle++; if(cycle>+els.cycles.value){ round++; if(round>+els.rounds.value){ return stop(); } cycle=1; } } const next=seq[phaseIndex % seq.length]; phaseTimeLeft=next.dur; }
  function updateScreen(phaseLabel,count){ $('#phase').textContent=phaseLabel; $('#counter').textContent=count; $('#roundsHint').textContent=`Rounds: ${round||0} ‚Ä¢ Cycle: ${cycle||0}`; }
  function progressUpdate(){ const seq=totalPhaseSeconds(); const total=seq.reduce((a,b)=>a+b.dur,0); const elapsedInCycle=(seq.slice(0, phaseIndex % seq.length).reduce((a,b)=>a+b.dur,0)) + (seq[phaseIndex % seq.length].dur - Math.max(0, phaseTimeLeft)); const pct=Math.max(0, Math.min(100,(elapsedInCycle/total)*100)); document.documentElement.style.setProperty('--progress', pct+'%'); }
  function start(){ if(running){ return; } running=true; paused=false; round=1; cycle=1; phaseIndex=0; phaseTimeLeft=totalPhaseSeconds()[0].dur; loop(); }
  function togglePause(){ paused=!paused; $('#btnPause').textContent= paused? '‚ñ∂ Resume':'‚è∏Ô∏è Pause'; if(!paused){ loop(); } }
  function stop(){ running=false; paused=false; clearTimeout(loopHandle); updateScreen('Done',0); }
  $('#btnStart').addEventListener('click', start);
  $('#btnPause').addEventListener('click', togglePause);
  $('#btnStop').addEventListener('click', stop);
  $('#btnReset').addEventListener('click', ()=>{ if(running) return; round=0; cycle=0; phaseIndex=0; phaseTimeLeft=0; updateScreen('Ready',0); });

  // --- timer (simple) ---
  let timerRunning=false, timerPaused=false, timerInterval=null, timerMsLeft=0, timerSetIndex=0, timerMode='work';
  function formatMMSS(ms){ const s=Math.max(0,Math.ceil(ms/1000)); const m=Math.floor(s/60); const ss=String(s%60).padStart(2,'0'); return `${String(m).padStart(2,'0')}:${ss}`; }
  function updateTimerHUD(){ $('#timerMMSS').textContent=formatMMSS(timerMsLeft); const totalSets=+els.timerSets.value; $('#timerSet').textContent=`(Set ${Math.min(timerSetIndex+1,totalSets)}/${totalSets}${timerMode==='rest'?' ‚Ä¢ Rest':''})`; $('#timerStatus').classList.remove('hidden'); }
  function startTimer(){ if(timerRunning) return; timerRunning=true; timerPaused=false; $('#btnTimerStart').disabled=true; $('#btnTimerPause').disabled=false; $('#btnTimerStop').disabled=false; timerMode='work'; timerSetIndex=0; timerMsLeft=+els.timerMinutes.value*60*1000; updateTimerHUD(); tickTimer(); timerInterval=setInterval(tickTimer,200); }
  function tickTimer(){ if(!timerRunning||timerPaused) return; timerMsLeft-=200; if(timerMsLeft<=0){ if(timerMode==='work'){ const restMin=+els.timerRest.value; const totalSets=+els.timerSets.value; if(restMin>0){ timerMode='rest'; timerMsLeft=restMin*60*1000; updateTimerHUD(); return; } else { timerSetIndex++; if(timerSetIndex>=totalSets){ return stopTimer(); } timerMode='work'; timerMsLeft=+els.timerMinutes.value*60*1000; updateTimerHUD(); return; } } else { const totalSets=+els.timerSets.value; timerSetIndex++; if(timerSetIndex>=totalSets){ return stopTimer(); } timerMode='work'; timerMsLeft=+els.timerMinutes.value*60*1000; } } updateTimerHUD(); }
  function pauseTimer(){ if(!timerRunning) return; timerPaused=!timerPaused; $('#btnTimerPause').textContent= timerPaused? 'Resume':'Pause'; }
  function stopTimer(){ timerRunning=false; timerPaused=false; clearInterval(timerInterval); $('#btnTimerStart').disabled=false; $('#btnTimerPause').disabled=true; $('#btnTimerStop').disabled=true; $('#timerStatus').classList.add('hidden'); }
  $('#btnTimerStart').addEventListener('click', startTimer);
  $('#btnTimerPause').addEventListener('click', pauseTimer);
  $('#btnTimerStop').addEventListener('click', stopTimer);

  // --- theme / background video ---
  const bgVideo = document.getElementById('bgVideo');
  const bgSrcWebm = document.getElementById('bgSrcWebm');
  const bgSrcMp4  = document.getElementById('bgSrcMp4');

  const THEME_MEDIA = {
    ocean:     { webm: 'media/ocean.webm',     mp4: 'media/ocean.mp4' },
    fireplace: { webm: 'media/fireplace.webm', mp4: 'media/fireplace.mp4' },
    waterfall: { webm: 'media/waterfall.webm', mp4: 'media/waterfall.mp4' }
  };

  const selTheme = els.selTheme, chkVideo = els.chkVideo, dimSlider = els.dimSlider;

  function savePrefs(){
    localStorage.setItem('ms.theme', selTheme.value);
    localStorage.setItem('ms.video', chkVideo.checked ? '1':'0');
    localStorage.setItem('ms.dim', String(dimSlider.value));
  }
  function loadPrefs(){
    selTheme.value = localStorage.getItem('ms.theme') || 'ocean';
    chkVideo.checked = localStorage.getItem('ms.video') !== '0';
    const d = parseFloat(localStorage.getItem('ms.dim') ?? '0.45');
    dimSlider.value = isNaN(d) ? 0.45 : d;
    document.documentElement.style.setProperty('--dim', dimSlider.value);
  }

  async function ensureBgVideo(){ try { await bgVideo?.play(); } catch(_) {} }

  function applyTheme(){
    const theme = selTheme.value;
    if (!chkVideo.checked || theme === 'none') {
      bgVideo.pause(); bgVideo.style.display = 'none'; savePrefs(); return;
    }
    const m = THEME_MEDIA[theme];
    if (!m) { bgVideo.pause(); bgVideo.style.display = 'none'; savePrefs(); return; }
    const vtag='?v=4'; // cache-bust
    bgSrcWebm.src = m.webm + vtag;
    bgSrcMp4.src  = m.mp4  + vtag;
    bgVideo.load();
    bgVideo.style.display = '';
    ensureBgVideo().finally(savePrefs);
  }

  // init
  loadPrefs();
  applyTheme();

  selTheme.addEventListener('change', applyTheme);
  chkVideo.addEventListener('change', applyTheme);
  dimSlider.addEventListener('input', () => {
    document.documentElement.style.setProperty('--dim', dimSlider.value);
    savePrefs();
  });

  // Retry video playback after user gesture (mobile)
  $('#btnStart').addEventListener('click', () => { ensureBgVideo(); });

  // Orientation tweak
  window.addEventListener('orientationchange', () => setTimeout(()=>window.scrollTo(0,1), 250));

  // Service worker (optional if sw.js present)
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('./sw.js').catch(()=>{});
  }
  </script>
</body>
</html>
