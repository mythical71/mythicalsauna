<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Mythical Sauna Breathing</title>
  <meta name="theme-color" content="#0f172a" />
  <style>
    :root{
      --bg:#0b1020; --card:#121a33; --accent:#22d3ee; --accent2:#a78bfa; --text:#e6f0ff; --muted:#90a4c8;
      --progress:0%; --footer-h:92px; --dim:0.5;
      --glow: rgba(56,189,248,0.35); /* default ocean-ish */
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; min-height:100svh; overflow-x:hidden;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,"Helvetica Neue",Arial;
      color:var(--text); background:var(--bg);
    }
    /* Background video */
    #bgVideo{position:fixed; inset:0; width:100%; height:100%; object-fit:cover; z-index:-2; background:#000; pointer-events:none;
      transition: opacity .4s ease; opacity:1;
    }
    /* Dim layer */
    body::before{content:""; position:fixed; inset:0; background:rgba(0,0,0,var(--dim)); z-index:-1; pointer-events:none;}
    /* Theme glow overlay (appears only on theme change) */
    #themeGlow{position:fixed; inset:0; z-index:-1; pointer-events:none; opacity:0;}
    #themeGlow.glow-active{ animation: glowPulse 700ms ease-in-out forwards; }
    @keyframes glowPulse{
      0%{ opacity:0; background:radial-gradient(120% 120% at 50% 50%, transparent 0%, transparent 40%, var(--glow) 60%, transparent 80%); filter: blur(0px); }
      35%{ opacity:.45; background:radial-gradient(120% 120% at 50% 50%, transparent 0%, var(--glow) 45%, var(--glow) 62%, transparent 82%); filter: blur(2px);}
      60%{ opacity:.25; background:radial-gradient(120% 120% at 50% 50%, transparent 0%, var(--glow) 35%, var(--glow) 55%, transparent 78%); filter: blur(1px);}
      100%{ opacity:0; background:radial-gradient(120% 120% at 50% 50%, transparent 0%, transparent 40%, var(--glow) 60%, transparent 80%); filter: blur(0px); }
    }

    /* Layout */
    .app{max-width:900px; margin:0 auto; padding:16px;
         padding-bottom:calc(var(--footer-h) + env(safe-area-inset-bottom) + 8px);
         position:relative; z-index:0}
    header{display:flex; align-items:center; justify-content:space-between; gap:12px; padding:10px 0}
    header h1{font-size:22px; margin:0; letter-spacing:.5px}
    .actions{display:flex; gap:8px; flex-wrap:wrap}
    button{appearance:none; border:0; background:linear-gradient(180deg,#1f2a4a,#10162b); color:var(--text);
      padding:10px 14px; border-radius:12px; font-weight:600; cursor:pointer;
      box-shadow:0 6px 18px rgba(0,0,0,.35), inset 0 0 0 1px rgba(255,255,255,.06);
      transition: transform .06s ease, box-shadow .12s ease, filter .12s ease;
    }
    button:disabled{opacity:.55; cursor:not-allowed}
    .btn-ghost{background:transparent; border:1px solid rgba(255,255,255,.12)}
    .grid{display:grid; gap:12px}
    .card{background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.08); border-radius:16px; padding:14px;
      box-shadow:0 20px 40px rgba(0,0,0,.25)
    }
    .row{display:flex; align-items:center; justify-content:space-between; gap:12px}
    .label{font-size:12px; color:var(--muted); letter-spacing:.3px}
    .value{font-weight:700}
    input[type="range"]{width:100%}
    input[type="number"]{width:90px; padding:8px; border-radius:8px; border:1px solid rgba(255,255,255,.15);
      background:rgba(255,255,255,.06); color:var(--text)
    }
    .circle-wrap{display:grid; place-items:center; margin:18px 0}
    .circle{width:min(88vw,68svh); height:min(88vw,68svh); border-radius:50%;
      background: radial-gradient(closest-side, rgba(34,211,238,.25), rgba(167,139,250,.12) 60%, transparent 61%),
                  conic-gradient(from 270deg, var(--accent) var(--progress), rgba(255,255,255,.06) 0%);
      display:grid; place-items:center; position:relative; transition:filter .3s ease;
      box-shadow: 0 0 0 1px rgba(255,255,255,.08), 0 12px 60px rgba(34,211,238,.15), inset 0 0 80px rgba(167,139,250,.12);
    }
    .circle-inner{width:85%; height:85%; border-radius:50%;
      background: radial-gradient(120% 100% at 50% 0%, rgba(167,139,250,.16), rgba(34,211,238,.08));
      display:grid; place-items:center; text-align:center; padding:12px;
    }
    .phase{font-size:14px; color:var(--muted); letter-spacing:.25px}
    .count{font-size:clamp(40px,10vw,72px); font-weight:900; line-height:1.05}
    .hint{font-size:12px; color:var(--muted)}
    .chips{display:flex; flex-wrap:wrap; gap:8px}
    .chip.active{outline:2px solid var(--accent)}
    .chip{padding:8px 12px; border-radius:999px; background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.1); cursor:pointer; font-weight:600}
    .twocol{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    @media (max-width: 900px){ .twocol{grid-template-columns:1fr} .circle-wrap{margin:8px 0} }
    .footer{position:fixed; left:0; right:0; bottom:0; height:var(--footer-h);
      padding:12px 16px; padding-bottom:calc(12px + env(safe-area-inset-bottom));
      backdrop-filter: blur(10px);
      background:linear-gradient(180deg, rgba(2,6,23,0), rgba(2,6,23,.85));
      border-top:1px solid rgba(255,255,255,.08); display:flex; align-items:center; gap:12px;
      z-index: 2;
    }
    .grow{flex:1}
    #btnStart.is-pressing, #btnStart:active {
      transform: translateY(1px) scale(0.98);
      box-shadow: 0 3px 10px rgba(0,0,0,.3), inset 0 0 0 1px rgba(255,255,255,.08);
      filter: brightness(0.95);
      outline: 2px solid rgba(34,211,238,.5);
      outline-offset: 0;
    }
  </style>
</head>
<body>
  <!-- Background layers -->
  <video id="bgVideo" autoplay muted loop playsinline>
    <source id="bgSrcWebm" src="" type="video/webm">
    <source id="bgSrcMp4"  src="" type="video/mp4">
  </video>
  <div id="themeGlow"></div>

  <div class="app">
    <header>
      <h1>🧖 Sauna Breathing</h1>
      <div class="actions">
        <button id="btnFullscreen" class="btn-ghost" title="Fullscreen">⤢</button>
      </div>
    </header>

    <section class="card circle-wrap">
      <div class="circle" id="circle">
        <div class="circle-inner">
          <div class="phase" id="phase">Ready</div>
          <div class="count" id="counter">0</div>
          <div class="hint" id="roundsHint">Rounds: 0 • Cycle: 0</div>
        </div>
      </div>
    </section>

    <!-- Presets -->
    <div class="card">
      <div class="chips" id="presets">
        <button class="chip" data-preset='{"name":"Box 4-4-4-4","inhale":4,"hold1":4,"exhale":4,"hold2":4,"cycles":12,"rounds":3}'>Box 4-4-4-4</button>
        <button class="chip" data-preset='{"name":"4-7-8","inhale":4,"hold1":7,"exhale":8,"hold2":0,"cycles":8,"rounds":3}'>4-7-8</button>
        <button class="chip" data-preset='{"name":"Sauna Calm","inhale":5,"hold1":0,"exhale":7,"hold2":0,"cycles":12,"rounds":3}'>Sauna Calm</button>
        <button class="chip" data-preset='{"name":"Wim Hof (guided)","inhale":2,"hold1":0,"exhale":2,"hold2":0,"cycles":30,"rounds":3}'>Wim Hof (guided)</button>
        <button class="chip" data-preset='{"name":"Custom"}'>Custom</button>
      </div>
    </div>

    <section class="grid">
      <div class="twocol">
        <div class="card grid">
          <!-- Timing controls -->
          <div class="row"><span class="label">Inhale (sec)</span><span class="value" id="vIn">5</span></div>
          <input class="range" id="rIn" type="range" min="1" max="12" value="5" />
          <div class="row"><span class="label">Hold after inhale (sec)</span><span class="value" id="vH1">0</span></div>
          <input class="range" id="rH1" type="range" min="0" max="20" value="0" />
          <div class="row"><span class="label">Exhale (sec)</span><span class="value" id="vEx">7</span></div>
          <input class="range" id="rEx" type="range" min="2" max="20" value="7" />
          <div class="row"><span class="label">Hold after exhale (sec)</span><span class="value" id="vH2">0</span></div>
          <input class="range" id="rH2" type="range" min="0" max="20" value="0" />
          <div class="row">
            <label class="label">Cycles per round</label>
            <input id="cycles" type="number" min="1" max="120" value="12"/>
            <label class="label">Rounds</label>
            <input id="rounds" type="number" min="1" max="20" value="3"/>
          </div>
        </div>

        <div class="card grid">
          <!-- Theme / Background / Audio controls -->
          <div class="row">
            <span class="label">Theme</span>
            <select id="selTheme">
              <option value="none">None</option>
              <option value="ocean">🌊 Ocean</option>
              <option value="fireplace">🔥 Fireplace</option>
              <option value="waterfall">💦 Waterfall</option>
            </select>
          </div>
          <div class="row">
            <span class="label">Animated background</span>
            <label><input id="chkVideo" type="checkbox" checked> On</label>
          </div>
          <div class="row">
            <span class="label">Background dim</span>
            <input id="dimSlider" type="range" min="0" max="0.85" step="0.01" value="0.5" class="range">
          </div>
          <hr style="opacity:.15; width:100%">

          <div class="row">
            <span class="label">Scene audio (use video sound)</span>
            <label><input id="chkSceneAudio" type="checkbox" checked> On</label>
          </div>
          <div class="row">
            <span class="label">Scene volume</span>
            <input id="volScene" type="range" min="0" max="1" step="0.01" value="0.5" class="range">
          </div>

          <div class="row">
            <span class="label">Ambient noise</span>
            <label><input id="chkAmbient" type="checkbox"> On</label>
          </div>
          <div class="row">
            <span class="label">Ambient volume</span>
            <input id="volAmbient" type="range" min="0" max="1" step="0.01" value="0.25" class="range">
          </div>

          <div class="row">
            <span class="label">Cue beeps</span>
            <label><input id="chkBeeps" type="checkbox" checked> On</label>
          </div>
          <div class="row">
            <span class="label">Voice counts</span>
            <label><input id="chkVoice" type="checkbox"> On</label>
          </div>
          <div class="row">
            <span class="label">Vibrate on phase</span>
            <label><input id="chkVibrate" type="checkbox" checked> On</label>
          </div>
        </div>
      </div>

      <div class="card">
        <h3 style="margin:6px 0 12px 0">⏱ Sauna Timer</h3>
        <div class="row" style="flex-wrap:wrap; gap:12px">
          <div><span class="label">Duration (min)</span><br><input id="timerMinutes" type="number" min="1" max="60" value="12"></div>
          <div><span class="label">Sets</span><br><input id="timerSets" type="number" min="1" max="20" value="3"></div>
          <div><span class="label">Rest between (min)</span><br><input id="timerRest" type="number" min="0" max="20" value="2"></div>
          <div class="row" style="gap:8px; margin-left:auto">
            <button id="btnTimerStart">Start Timer</button>
            <button id="btnTimerPause" disabled>Pause</button>
            <button id="btnTimerStop" disabled>Stop</button>
          </div>
        </div>
      </div>
    </section>
  </div>

  <div class="footer row">
    <div class="row grow" style="gap:8px">
      <button id="btnStart" aria-pressed="false">▶ Start</button>
      <button id="btnPause" disabled>⏸️ Pause</button>
      <button id="btnStop" disabled>■ Stop</button>
    </div>
    <div class="row" style="gap:8px">
      <button id="btnReset" class="btn-ghost">Reset</button>
    </div>
  </div>

  <script>
  (function(){
    'use strict';
    const $ = s => document.querySelector(s);
    const els = {
      rIn: $('#rIn'), rH1: $('#rH1'), rEx: $('#rEx'), rH2: $('#rH2'),
      vIn: $('#vIn'), vH1: $('#vH1'), vEx: $('#vEx'), vH2: $('#vH2'),
      cycles: $('#cycles'), rounds: $('#rounds'),
      btnStart: $('#btnStart'), btnPause: $('#btnPause'), btnStop: $('#btnStop'), btnReset: $('#btnReset'),
      timerMinutes: $('#timerMinutes'), timerSets: $('#timerSets'), timerRest: $('#timerRest'),
      btnTimerStart: $('#btnTimerStart'), btnTimerPause: $('#btnTimerPause'), btnTimerStop: $('#btnTimerStop'),
      selTheme: $('#selTheme'), chkVideo: $('#chkVideo'), dimSlider: $('#dimSlider'),
      chkSceneAudio: $('#chkSceneAudio'), volScene: $('#volScene'),
      chkAmbient: $('#chkAmbient'), volAmbient: $('#volAmbient'),
      chkBeeps: $('#chkBeeps'), chkVoice: $('#chkVoice'), chkVibrate: $('#chkVibrate'),
      bgVideo: $('#bgVideo'), bgSrcWebm: $('#bgSrcWebm'), bgSrcMp4: $('#bgSrcMp4'),
      glow: $('#themeGlow')
    };

    // ===== Audio context =====
    let audioCtx=null, ambientNode=null, ambientGain=null;
    function ensureAudio(){ try{ if(!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)(); if(audioCtx.state==='suspended') audioCtx.resume(); }catch{} }
    function ensurePlay(){ try{ els.bgVideo.play(); }catch{} }

    // ===== Ambient noise =====
    function startAmbient(){
      ensureAudio(); if(!audioCtx || ambientNode) return;
      const len = 2 * audioCtx.sampleRate;
      const buff = audioCtx.createBuffer(1, len, audioCtx.sampleRate);
      const data = buff.getChannelData(0);
      let lastOut = 0.0;
      for (let i=0;i<len;i++){
        const white = Math.random()*2-1;
        lastOut = (lastOut + (0.02 * white)) / 1.02;
        data[i] = lastOut * 3.5;
      }
      const src = audioCtx.createBufferSource();
      src.buffer = buff; src.loop = true;
      const filt = audioCtx.createBiquadFilter(); filt.type='lowpass'; filt.frequency.value = 800;
      const g = audioCtx.createGain(); g.gain.value = parseFloat(els.volAmbient.value || '0.25');
      src.connect(filt); filt.connect(g); g.connect(audioCtx.destination);
      src.start();
      ambientNode = src; ambientGain = g;
    }
    function stopAmbient(){ try{ ambientNode?.stop(); }catch{} ambientNode=null; ambientGain=null; }

    // ===== Cues =====
    function beep(freq=440, duration=0.12, gain=0.12){
      if(!els.chkBeeps.checked) return;
      try{
        ensureAudio();
        const ctx=audioCtx; if(!ctx) return;
        const osc = ctx.createOscillator();
        const g = ctx.createGain();
        osc.type = 'sine'; osc.frequency.value = freq;
        g.gain.value = 0.0001;
        osc.connect(g); g.connect(ctx.destination);
        const now = ctx.currentTime;
        g.gain.setValueAtTime(0.0001, now);
        g.gain.linearRampToValueAtTime(gain, now + 0.02);
        g.gain.exponentialRampToValueAtTime(0.0001, now + duration);
        osc.start(now);
        osc.stop(now + duration + 0.02);
      }catch{}
    }
    function speak(txt){
      if(!els.chkVoice.checked) return;
      try{
        const u = new SpeechSynthesisUtterance(txt);
        u.rate = 1.0; u.pitch = 1.0; u.volume = 0.9;
        speechSynthesis.cancel();
        speechSynthesis.speak(u);
      }catch{}
    }
    function vibrate(pattern=[20]){ if(!els.chkVibrate.checked) return; if(navigator.vibrate){ try{ navigator.vibrate(pattern); }catch{} } }

    // ===== Presets =====
    const PRESET_STORAGE_KEY = 'ms.preset';
    const presetsEl = document.getElementById('presets');
    function updateVals(){
      els.vIn.textContent = els.rIn.value;
      els.vH1.textContent = els.rH1.value;
      els.vEx.textContent = els.rEx.value;
      els.vH2.textContent = els.rH2.value;
      document.documentElement.style.setProperty('--progress','0%');
    }
    [els.rIn,els.rH1,els.rEx,els.rH2].forEach(r=>r.addEventListener('input', updateVals));
    function applyPreset(p){
      if (p.inhale != null)  els.rIn.value   = p.inhale;
      if (p.hold1  != null)  els.rH1.value   = p.hold1;
      if (p.exhale != null)  els.rEx.value   = p.exhale;
      if (p.hold2  != null)  els.rH2.value   = p.hold2;
      if (p.cycles != null)  els.cycles.value= p.cycles;
      if (p.rounds != null)  els.rounds.value= p.rounds;
      updateVals();
    }
    function loadPreset(){ try{ const raw = localStorage.getItem(PRESET_STORAGE_KEY); if(raw) applyPreset(JSON.parse(raw)); }catch{} }
    function savePreset(p){ try{ localStorage.setItem(PRESET_STORAGE_KEY, JSON.stringify(p)); }catch{} }
    if (presetsEl) {
      presetsEl.addEventListener('click', (e) => {
        const chip = e.target.closest('.chip'); if (!chip) return;
        [...presetsEl.children].forEach(c => c.classList.remove('active'));
        chip.classList.add('active');
        const p = JSON.parse(chip.dataset.preset);
        if (p.name !== 'Custom') applyPreset(p);
        savePreset(p);
      });
    }

    // ===== Breathing engine =====
    let running=false, paused=false, round=0, cycle=0, phaseIndex=0, phaseTimeLeft=0, interval=null, lastSpoken=-1;
    const phasesBase=[{key:'inhale',label:'Inhale'},{key:'hold1',label:'Hold'},{key:'exhale',label:'Exhale'},{key:'hold2',label:'Hold'}];
    function seq(){
      const arr=[+els.rIn.value,+els.rH1.value,+els.rEx.value,+els.rH2.value];
      let s = arr.map((v,i)=>({dur:Math.max(0,v), ...phasesBase[i]}));
      if (s[0].dur===0 && s[2].dur===0) { s[0].dur=4; s[2].dur=4; }
      return s.filter(p=>p.dur>0);
    }
    function updateHUD(label,count){
      document.getElementById('phase').textContent = label;
      document.getElementById('counter').textContent = count;
      document.getElementById('roundsHint').textContent = `Rounds: ${round||0} • Cycle: ${cycle||0}`;
    }
    function progressUpdate(s){
      const total=s.reduce((a,b)=>a+b.dur,0);
      const elapsed=(s.slice(0, phaseIndex % s.length).reduce((a,b)=>a+b.dur,0)) + (s[phaseIndex % s.length].dur - Math.max(0, phaseTimeLeft));
      const pct=Math.max(0, Math.min(100,(elapsed/total)*100));
      document.documentElement.style.setProperty('--progress', pct+'%');
    }
    function tick(){
      const s = seq(); if (s.length===0) return;
      const cur = s[phaseIndex % s.length];
      if (!paused){
        phaseTimeLeft -= 0.2;
        const display = Math.max(0, Math.ceil(phaseTimeLeft));
        if (els.chkVoice.checked && display !== lastSpoken){
          lastSpoken = display;
          if (display > 0 && display <= 5) speak(String(display));
        }
        if (phaseTimeLeft <= 0){
          beep(cur.key==='exhale' ? 520 : 440, 0.10, 0.10);
          vibrate([12,30,12]);
          phaseIndex++;
          lastSpoken = -1;
          if (phaseIndex % s.length === 0){
            cycle++;
            if (cycle > +els.cycles.value){ round++; if (round > +els.rounds.value){ stop(); return; } cycle = 1; }
          }
          const nxt = s[phaseIndex % s.length];
          phaseTimeLeft = nxt.dur;
          updateHUD(nxt.label, Math.max(0, Math.ceil(phaseTimeLeft)));
          if (els.chkVoice.checked) speak(nxt.label);
        } else {
          updateHUD(cur.label, display);
        }
        progressUpdate(s);
      }
    }
    function start(){
      if(running) return;
      ensureAudio(); ensurePlay();
      if (els.chkSceneAudio.checked){ els.bgVideo.muted = false; els.bgVideo.volume = parseFloat(els.volScene.value || '0.5'); stopAmbient(); }
      else { els.bgVideo.muted = true; if (els.chkAmbient.checked) startAmbient(); }
      speak('Start'); vibrate([20]); beep(660, 0.12, 0.12);
      running = true; paused = false; round = 1; cycle = 1; phaseIndex = 0; lastSpoken=-1;
      const s = seq(); phaseTimeLeft = s[0].dur;
      updateHUD(s[0].label, Math.max(0, Math.ceil(phaseTimeLeft)));
      if (els.chkVoice.checked) speak(s[0].label);
      els.btnStart.disabled = true; els.btnPause.disabled = false; els.btnStop.disabled = false;
      interval = setInterval(tick, 200);
    }
    function togglePause(){
      if(!running) return;
      paused = !paused;
      els.btnPause.textContent = paused ? '▶ Resume' : '⏸️ Pause';
    }
    function stop(){
      running=false; paused=false; clearInterval(interval);
      els.btnStart.disabled = false; els.btnPause.disabled = true; els.btnStop.disabled = true; els.btnPause.textContent='⏸️ Pause';
      updateHUD('Ready',0); document.documentElement.style.setProperty('--progress','0%');
      speak('Stop');
    }

    // ===== Theme / Background Video + Prefs =====
    const THEME_MEDIA = {
      ocean:     { webm: 'media/ocean.webm',     mp4: 'media/ocean.mp4',     glow:'rgba(56,189,248,0.35)'  },
      fireplace: { webm: 'media/fireplace.webm', mp4: 'media/fireplace.mp4', glow:'rgba(251,146,60,0.35)' },
      waterfall: { webm: 'media/waterfall.webm', mp4: 'media/waterfall.mp4', glow:'rgba(45,212,191,0.35)' }
    };
    const PREFS = {
      theme:'ms.theme', video:'ms.video', dim:'ms.dim',
      scene:'ms.sceneAudio', sceneVol:'ms.sceneVol',
      ambient:'ms.ambient', ambVol:'ms.ambVol', beeps:'ms.beeps', voice:'ms.voice', vib:'ms.vib'
    };
    function savePrefs(){
      localStorage.setItem(PREFS.theme, els.selTheme.value);
      localStorage.setItem(PREFS.video, els.chkVideo.checked ? '1':'0');
      localStorage.setItem(PREFS.dim, String(els.dimSlider.value));
      localStorage.setItem(PREFS.scene, els.chkSceneAudio.checked ? '1':'0');
      localStorage.setItem(PREFS.sceneVol, String(els.volScene.value));
      localStorage.setItem(PREFS.ambient, els.chkAmbient.checked ? '1':'0');
      localStorage.setItem(PREFS.ambVol, String(els.volAmbient.value));
      localStorage.setItem(PREFS.beeps, els.chkBeeps.checked ? '1':'0');
      localStorage.setItem(PREFS.voice, els.chkVoice.checked ? '1':'0');
      localStorage.setItem(PREFS.vib, els.chkVibrate.checked ? '1':'0');
    }
    function loadPrefs(){
      els.selTheme.value   = localStorage.getItem(PREFS.theme) || 'ocean';
      els.chkVideo.checked = localStorage.getItem(PREFS.video) !== '0';
      const d = parseFloat(localStorage.getItem(PREFS.dim) ?? '0.5');
      els.dimSlider.value = isNaN(d) ? 0.5 : d;
      els.chkSceneAudio.checked = (localStorage.getItem(PREFS.scene) ?? '1') === '1'; // default ON
      els.volScene.value = localStorage.getItem(PREFS.sceneVol) ?? '0.5';
      els.chkAmbient.checked = localStorage.getItem(PREFS.ambient) === '1';
      els.volAmbient.value = localStorage.getItem(PREFS.ambVol) ?? '0.25';
      els.chkBeeps.checked = localStorage.getItem(PREFS.beeps) !== '0';
      els.chkVoice.checked = localStorage.getItem(PREFS.voice) === '1';
      els.chkVibrate.checked = localStorage.getItem(PREFS.vib) !== '0';
      document.documentElement.style.setProperty('--dim', els.dimSlider.value);
    }

    // Smooth ramps
    function rampVolume(el, to, ms){
      return new Promise(resolve=>{
        const from = el.volume;
        const start = performance.now();
        function step(now){
          const t = Math.min(1, (now - start)/ms);
          el.volume = from + (to - from) * t;
          if (t < 1) requestAnimationFrame(step); else resolve();
        }
        requestAnimationFrame(step);
      });
    }
    function rampGain(gainNode, to, ms){
      return new Promise(resolve=>{
        if(!gainNode){ resolve(); return; }
        const from = gainNode.gain.value;
        const start = performance.now();
        function step(now){
          const t = Math.min(1, (now - start)/ms);
          gainNode.gain.value = from + (to - from) * t;
          if (t < 1) requestAnimationFrame(step); else resolve();
        }
        requestAnimationFrame(step);
      });
    }

    // Apply theme (visual fade + theme-coloured glow + audio crossfade)
    async function applyTheme(){
      const theme = els.selTheme.value;
      if(!els.chkVideo.checked || theme==='none'){
        els.bgVideo.pause(); els.bgVideo.style.display='none'; savePrefs(); return;
      }
      const m = THEME_MEDIA[theme];
      if(!m){ els.bgVideo.pause(); els.bgVideo.style.display='none'; savePrefs(); return; }

      // Set theme glow color & trigger pulse
      document.documentElement.style.setProperty('--glow', m.glow || 'rgba(56,189,248,0.35)');
      els.glow.classList.remove('glow-active'); void els.glow.offsetWidth; // restart animation
      els.glow.classList.add('glow-active');

      // Visual fade out (video)
      els.bgVideo.style.opacity = 0;

      const targetVol = parseFloat(els.volScene.value || '0.5');
      // If scene audio is currently active, fade it out
      if (!els.bgVideo.muted && els.bgVideo.volume > 0){
        try{ await rampVolume(els.bgVideo, 0, 300); }catch{}
      }

      // Delay half the glow duration (~350ms) before swapping sources (feels synced)
      await new Promise(r => setTimeout(r, 350));

      // Swap sources
      const vtag='?v=19';
      els.bgSrcWebm.src = m.webm + vtag;
      els.bgSrcMp4.src  = m.mp4  + vtag;
      els.bgVideo.load();
      els.bgVideo.style.display='';
      ensurePlay();

      // Auto-enable scene audio + disable ambient
      els.chkSceneAudio.checked = true;
      els.chkAmbient.checked = false; stopAmbient();
      els.bgVideo.muted = false;
      els.bgVideo.volume = 0.0; // start at 0, ramp in
      savePrefs();

      // When ready, fade video in and ramp volume up
      const onCanPlay = async () => {
        els.bgVideo.removeEventListener('canplay', onCanPlay);
        els.bgVideo.style.opacity = 1;
        try{ await rampVolume(els.bgVideo, targetVol, 600); }catch{ els.bgVideo.volume = targetVol; }
      };
      els.bgVideo.addEventListener('canplay', onCanPlay, { once:true });
    }

    // ===== Bind UI =====
    function addPressFeedback(btn, onTrigger){
      if(!btn) return;
      const pressOn = (e)=>{ e.preventDefault(); btn.classList.add('is-pressing'); btn.setAttribute('aria-pressed','true'); };
      const pressOff = (e)=>{ btn.classList.remove('is-pressing'); btn.setAttribute('aria-pressed','false'); };
      const trigger = (e)=>{ e.preventDefault(); e.stopPropagation(); pressOff(); onTrigger?.(); };
      btn.addEventListener('touchstart', pressOn, {passive:false});
      btn.addEventListener('pointerdown', pressOn, {passive:false});
      btn.addEventListener('mousedown', pressOn);
      btn.addEventListener('touchend', trigger, {passive:false});
      btn.addEventListener('pointerup', trigger, {passive:false});
      btn.addEventListener('mouseup', trigger);
      btn.addEventListener('mouseleave', pressOff);
      btn.addEventListener('click', (e)=>{ e.preventDefault(); trigger(e); });
    }
    addPressFeedback(els.btnStart, ()=>{ ensureAudio(); ensurePlay(); start(); });
    els.btnPause.addEventListener('click', (e)=>{ e.preventDefault(); togglePause(); });
    els.btnStop.addEventListener('click', (e)=>{ e.preventDefault(); stop(); });
    els.btnReset.addEventListener('click', (e)=>{ e.preventDefault(); if(running) return; round=0; cycle=0; phaseIndex=0; phaseTimeLeft=0; updateHUD('Ready',0); });

    // Ambient <-> Scene crossfades (AUDIO ONLY) — kept from v18
    async function crossfadeToScene(){
      ensureAudio(); ensurePlay();
      const targetVol = parseFloat(els.volScene.value || '0.5');
      if (ambientGain){ try{ await rampGain(ambientGain, 0.0, 300); }catch{} }
      stopAmbient();
      els.bgVideo.muted = false;
      els.bgVideo.volume = 0.0;
      try{ await rampVolume(els.bgVideo, targetVol, 550); }catch{ els.bgVideo.volume = targetVol; }
    }
    async function crossfadeToAmbient(){
      ensureAudio(); ensurePlay();
      const targetGain = parseFloat(els.volAmbient.value || '0.25');
      try{ await rampVolume(els.bgVideo, 0.0, 300); }catch{ els.bgVideo.volume = 0.0; }
      els.bgVideo.muted = true;
      if (!ambientNode){ startAmbient(); }
      if (ambientGain){ ambientGain.gain.value = 0.0; try{ await rampGain(ambientGain, targetGain, 550); }catch{ ambientGain.gain.value = targetGain; } }
    }

    // Scene audio + Ambient interlock with crossfades
    els.chkSceneAudio.addEventListener('change', async ()=>{
      if (els.chkSceneAudio.checked){
        els.chkAmbient.checked = false;
        await crossfadeToScene();
      } else {
        els.bgVideo.muted = true;
      }
      savePrefs();
    });
    els.volScene.addEventListener('input', ()=>{ els.bgVideo.volume = parseFloat(els.volScene.value || '0.5'); savePrefs(); });
    els.chkAmbient.addEventListener('change', async ()=>{
      if (els.chkAmbient.checked){
        els.chkSceneAudio.checked = false;
        await crossfadeToAmbient();
      } else {
        stopAmbient();
      }
      savePrefs();
    });
    els.volAmbient.addEventListener('input', ()=>{ if(ambientGain) ambientGain.gain.value = parseFloat(els.volAmbient.value); savePrefs(); });

    // Timer
    let tRun=false, tPause=false, tInt=null, tMs=0, tSet=0, tMode='work';
    const fmt = ms => { const s=Math.max(0,Math.ceil(ms/1000)); const m=Math.floor(s/60); const ss=String(s%60).padStart(2,'0'); return `${String(m).padStart(2,'0')}:${ss}`; };
    function updTimer(){
      let pill=document.getElementById('timerPill');
      if(!pill){ pill=document.createElement('div'); pill.id='timerPill'; pill.style.cssText='position:fixed;top:10px;right:10px;background:rgba(0,0,0,.35);border:1px solid rgba(255,255,255,.2);padding:6px 10px;border-radius:999px;font-variant-numeric:tabular-nums;z-index:2'; document.body.appendChild(pill); }
      pill.textContent = `⏱ ${fmt(tMs)} (Set ${tSet+1}/${+els.timerSets.value}${tMode==='rest'?' • Rest':''})`;
    }
    function timerStart(){
      if(tRun) return;
      ensureAudio(); ensurePlay();
      tRun=true; tPause=false; tMode='work'; tSet=0; tMs=+els.timerMinutes.value*60*1000;
      els.btnTimerPause.disabled=false; els.btnTimerStop.disabled=false;
      updTimer();
      tInt = setInterval(()=>{
        if(!tRun || tPause) return;
        tMs -= 200;
        if(tMs<=0){
          const total=+els.timerSets.value;
          beep(700, 0.12, 0.12); vibrate([18]);
          if(tMode==='work'){
            const rest=+els.timerRest.value;
            if(rest>0){ tMode='rest'; tMs=rest*60*1000; }
            else { tSet++; if(tSet>=total){ return timerStop(true); } tMode='work'; tMs=+els.timerMinutes.value*60*1000; }
          } else {
            tSet++; if(tSet>=total){ return timerStop(true); } tMode='work'; tMs=+els.timerMinutes.value*60*1000;
          }
        }
        updTimer();
      },200);
    }
    function timerPause(){ if(!tRun) return; tPause=!tPause; els.btnTimerPause.textContent = tPause?'Resume':'Pause'; }
    function timerStop(final=false){ tRun=false; tPause=false; clearInterval(tInt); els.btnTimerPause.textContent='Pause'; els.btnTimerPause.disabled=true; els.btnTimerStop.disabled=true; const pill=document.getElementById('timerPill'); if(pill) pill.remove(); }

    // Init + listeners
    loadPrefs(); applyTheme(); loadPreset();
    els.selTheme.addEventListener('change', applyTheme);
    els.chkVideo.addEventListener('change', applyTheme);
    els.dimSlider.addEventListener('input', ()=>{ document.documentElement.style.setProperty('--dim', els.dimSlider.value); savePrefs(); });
    document.getElementById('btnFullscreen').addEventListener('click', ()=>{
      const el=document.documentElement; if(!document.fullscreenElement){ el.requestFullscreen?.(); } else { document.exitFullscreen?.(); }
    });

    // Global unlock on first gesture
    ['touchend','pointerup','click'].forEach(evt => {
      document.body.addEventListener(evt, ()=>{ ensureAudio(); ensurePlay(); }, { once:true, passive:true });
    });
  })();
  </script>
</body>
</html>
