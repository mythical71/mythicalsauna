<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Mythical Sauna Breathing</title>
  <meta name="theme-color" content="#0f172a" />
  <style>
    :root{
      --bg:#0b1020; --card:#121a33; --accent:#22d3ee; --accent2:#a78bfa; --text:#e6f0ff; --muted:#90a4c8;
      --progress:0%; --footer-h:92px; --dim:0.5;
      --glow: rgba(56,189,248,0.35);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; min-height:100svh; overflow-x:hidden;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,"Helvetica Neue",Arial;
      color:var(--text); background:var(--bg);
    }
    .bgwrap{position:fixed; inset:0; z-index:-2}
    video.bg{position:absolute; inset:0; width:100%; height:100%; object-fit:cover; background:#000; pointer-events:none; opacity:0; transition:opacity .35s ease}
    .bg.dim::after{content:""; position:absolute; inset:0; background:rgba(0,0,0,var(--dim));}
    #themeGlow{position:fixed; inset:0; z-index:-1; pointer-events:none; opacity:0;}
    #themeGlow.glow-active{ animation: glowPulse 700ms ease-in-out forwards; }
    @keyframes glowPulse{
      0%{ opacity:0; background:radial-gradient(120% 120% at 50% 50%, transparent 0%, transparent 40%, var(--glow) 60%, transparent 80%); filter: blur(0px); }
      35%{ opacity:.45; background:radial-gradient(120% 120% at 50% 50%, transparent 0, var(--glow) 45%, var(--glow) 62%, transparent 82%); filter: blur(2px);}
      60%{ opacity:.25; background:radial-gradient(120% 120% at 50% 50%, transparent 0, var(--glow) 35%, var(--glow) 55%, transparent 78%); filter: blur(1px);}
      100%{ opacity:0; background:radial-gradient(120% 120% at 50% 50%, transparent 0%, transparent 40%, var(--glow) 60%, transparent 80%); filter: blur(0px); }
    }
    .app{max-width:900px; margin:0 auto; padding:16px; padding-bottom:calc(var(--footer-h) + env(safe-area-inset-bottom) + 8px); position:relative; z-index:0}
    header{display:flex; align-items:center; justify-content:space-between; gap:12px; padding:10px 0}
    header h1{font-size:22px; margin:0; letter-spacing:.5px}
    .actions{display:flex; gap:8px; flex-wrap:wrap}
    button{appearance:none; border:0; background:linear-gradient(180deg,#1f2a4a,#10162b); color:var(--text);
      padding:10px 14px; border-radius:12px; font-weight:600; cursor:pointer;
      box-shadow:0 6px 18px rgba(0,0,0,.35), inset 0 0 0 1px rgba(255,255,255,.06);
      transition: transform .06s ease, box-shadow .12s ease, filter .12s ease;
    }
    button:disabled{opacity:.55; cursor:not-allowed}
    .btn-ghost{background:transparent; border:1px solid rgba(255,255,255,.12)}
    .grid{display:grid; gap:12px}
    .card{background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.08); border-radius:16px; padding:14px;
      box-shadow:0 20px 40px rgba(0,0,0,.25)
    }
    .row{display:flex; align-items:center; justify-content:space-between; gap:12px}
    .label{font-size:12px; color:var(--muted); letter-spacing:.3px}
    .value{font-weight:700}
    input[type="range"]{width:100%}
    input[type="number"]{width:90px; padding:8px; border-radius:8px; border:1px solid rgba(255,255,255,.15);
      background:rgba(255,255,255,.06); color:var(--text)
    }
    .circle-wrap{display:grid; place-items:center; margin:18px 0}
    .circle{width:min(88vw,68svh); height:min(88vw,68svh); border-radius:50%;
      background: radial-gradient(closest-side, rgba(34,211,238,.25), rgba(167,139,250,.12) 60%, transparent 61%),
                  conic-gradient(from 270deg, var(--accent) var(--progress), rgba(255,255,255,.06) 0%);
      display:grid; place-items:center; position:relative; transition:filter .3s ease;
      box-shadow: 0 0 0 1px rgba(255,255,255,.08), 0 12px 60px rgba(34,211,238,.15), inset 0 0 80px rgba(167,139,250,.12);
    }
    .circle-inner{width:85%; height:85%; border-radius:50%;
      background: radial-gradient(120% 100% at 50% 0%, rgba(167,139,250,.16), rgba(34,211,238,.08));
      display:grid; place-items:center; text-align:center; padding:12px;
    }
    .phase{font-size:14px; color:var(--muted); letter-spacing:.25px}
    .count{font-size:clamp(40px,10vw,72px); font-weight:900; line-height:1.05}
    .hint{font-size:12px; color:var(--muted)}
    .chips{display:flex; flex-wrap:wrap; gap:8px}
    .chip.active{outline:2px solid var(--accent)}
    .chip{padding:8px 12px; border-radius:999px; background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.1); cursor:pointer; font-weight:600}
    .twocol{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    @media (max-width: 900px){ .twocol{grid-template-columns:1fr} .circle-wrap{margin:8px 0} }
    .footer{position:fixed; left:0; right:0; bottom:0; height:var(--footer-h);
      padding:12px 16px; padding-bottom:calc(12px + env(safe-area-inset-bottom));
      backdrop-filter: blur(10px);
      background:linear-gradient(180deg, rgba(2,6,23,0), rgba(2,6,23,.85));
      border-top:1px solid rgba(255,255,255,.08); display:flex; align-items:center; gap:12px;
      z-index: 2;
    }
    .grow{flex:1}
    #toast{position:fixed;left:50%;bottom:calc(var(--footer-h) + 10px);transform:translateX(-50%);
      background:rgba(0,0,0,.5);border:1px solid rgba(255,255,255,.15);padding:8px 12px;border-radius:10px;z-index:3;display:none}
  </style>
</head>
<body>
  <div class="bgwrap">
    <video id="bgA" class="bg" autoplay playsinline muted preload="auto"></video>
    <video id="bgB" class="bg" autoplay playsinline muted preload="auto"></video>
  </div>
  <div id="themeGlow"></div>
  <div id="toast"></div>

  <div class="app">
    <header>
      <h1>🧖 Sauna Breathing</h1>
      <div class="actions">
        <button id="btnFullscreen" class="btn-ghost" title="Fullscreen">⤢</button>
      </div>
    </header>

    <section class="card circle-wrap">
      <div class="circle" id="circle">
        <div class="circle-inner">
          <div class="phase" id="phase">Ready</div>
          <div class="count" id="counter">0</div>
          <div class="hint" id="roundsHint">Rounds: 0 • Cycle: 0</div>
        </div>
      </div>
    </section>

    <div class="card">
      <div class="chips" id="presets">
        <button class="chip" data-preset='{"name":"Box 4-4-4-4","inhale":4,"hold1":4,"exhale":4,"hold2":4,"cycles":12,"rounds":3}'>Box 4-4-4-4</button>
        <button class="chip" data-preset='{"name":"4-7-8","inhale":4,"hold1":7,"exhale":8,"hold2":0,"cycles":8,"rounds":3}'>4-7-8</button>
        <button class="chip" data-preset='{"name":"Sauna Calm","inhale":5,"hold1":0,"exhale":7,"hold2":0,"cycles":12,"rounds":3}'>Sauna Calm</button>
        <button class="chip" data-preset='{"name":"Wim Hof (guided)","inhale":2,"hold1":0,"exhale":2,"hold2":0,"cycles":30,"rounds":3}'>Wim Hof (guided)</button>
        <button class="chip" data-preset='{"name":"Custom"}'>Custom</button>
      </div>
    </div>

    <section class="grid">
      <div class="twocol">
        <div class="card grid">
          <div class="row"><span class="label">Inhale (sec)</span><span class="value" id="vIn">5</span></div>
          <input class="range" id="rIn" type="range" min="1" max="12" value="5" />
          <div class="row"><span class="label">Hold after inhale (sec)</span><span class="value" id="vH1">0</span></div>
          <input class="range" id="rH1" type="range" min="0" max="20" value="0" />
          <div class="row"><span class="label">Exhale (sec)</span><span class="value" id="vEx">7</span></div>
          <input class="range" id="rEx" type="range" min="2" max="20" value="7" />
          <div class="row"><span class="label">Hold after exhale (sec)</span><span class="value" id="vH2">0</span></div>
          <input class="range" id="rH2" type="range" min="0" max="20" value="0" />
          <div class="row">
            <label class="label">Cycles per round</label>
            <input id="cycles" type="number" min="1" max="120" value="12"/>
            <label class="label">Rounds</label>
            <input id="rounds" type="number" min="1" max="20" value="3"/>
          </div>
        </div>

        <div class="card grid">
          <div class="row">
            <span class="label">Theme</span>
            <select id="selTheme">
              <option value="none">None</option>
              <option value="ocean">🌊 Ocean</option>
              <option value="fireplace">🔥 Fireplace</option>
              <option value="waterfall">💦 Waterfall</option>
            </select>
          </div>
          <div class="row">
            <span class="label">Animated background</span>
            <label><input id="chkVideo" type="checkbox" checked> On</label>
          </div>
          <div class="row">
            <span class="label">Background dim</span>
            <input id="dimSlider" type="range" min="0" max="0.85" step="0.01" value="0.5" class="range">
          </div>
          <hr style="opacity:.15; width:100%">

          <div class="row">
            <span class="label">Scene audio (use video sound)</span>
            <label><input id="chkSceneAudio" type="checkbox" checked> On</label>
          </div>
          <div class="row">
            <span class="label">Scene volume</span>
            <input id="volScene" type="range" min="0" max="1" step="0.01" value="0.5" class="range">
          </div>

          <div class="row">
            <span class="label">Cue beeps</span>
            <label><input id="chkBeeps" type="checkbox" checked> On</label>
          </div>
          <div class="row">
            <span class="label">Voice counts</span>
            <label><input id="chkVoice" type="checkbox"> On</label>
          </div>
          <div class="row">
            <span class="label">Vibrate on phase</span>
            <label><input id="chkVibrate" type="checkbox" checked> On</label>
          </div>
        </div>
      </div>

      <div class="card">
        <h3 style="margin:6px 0 12px 0">⏱ Sauna Timer</h3>
        <div class="row" style="flex-wrap:wrap; gap:12px">
          <div><span class="label">Duration (min)</span><br><input id="timerMinutes" type="number" min="1" max="60" value="12"></div>
          <div><span class="label">Sets</span><br><input id="timerSets" type="number" min="1" max="20" value="3"></div>
          <div><span class="label">Rest between (min)</span><br><input id="timerRest" type="number" min="0" max="20" value="2"></div>
          <div class="row" style="gap:8px; margin-left:auto">
            <button id="btnTimerStart">Start Timer</button>
            <button id="btnTimerPause" disabled>Pause</button>
            <button id="btnTimerStop" disabled>Stop</button>
          </div>
        </div>
      </div>
    </section>
  </div>

  <div class="footer row">
    <div class="row grow" style="gap:8px">
      <button id="btnStart" aria-pressed="false">▶ Start</button>
      <button id="btnPause" disabled>⏸️ Pause</button>
      <button id="btnStop" disabled>■ Stop</button>
    </div>
    <div class="row" style="gap:8px">
      <button id="btnReset" class="btn-ghost">Reset</button>
    </div>
  </div>

  <script>
  (function(){
    'use strict';
    const $ = s => document.querySelector(s);
    const els = {
      bgA: $('#bgA'), bgB: $('#bgB'),
      rIn: $('#rIn'), rH1: $('#rH1'), rEx: $('#rEx'), rH2: $('#rH2'),
      vIn: $('#vIn'), vH1: $('#vH1'), vEx: $('#vEx'), vH2: $('#vH2'),
      cycles: $('#cycles'), rounds: $('#rounds'),
      selTheme: $('#selTheme'), chkVideo: $('#chkVideo'), dimSlider: $('#dimSlider'),
      chkSceneAudio: $('#chkSceneAudio'), volScene: $('#volScene'),
      chkBeeps: $('#chkBeeps'), chkVoice: $('#chkVoice'), chkVibrate: $('#chkVibrate'),
      glow: $('#themeGlow'),
      btnStart: $('#btnStart'), btnPause: $('#btnPause'), btnStop: $('#btnStop'), btnReset: $('#btnReset'),
      timerMinutes: $('#timerMinutes'), timerSets: $('#timerSets'), timerRest: $('#timerRest'),
      btnTimerStart: $('#btnTimerStart'), btnTimerPause: $('#btnTimerPause'), btnTimerStop: $('#btnTimerStop'),
      toast: $('#toast'),
      presets: document.getElementById('presets')
    };

    // ===== Small helpers =====
    function showToast(msg, ms=1000){ els.toast.textContent=msg; els.toast.style.display='block'; clearTimeout(window._t); window._t=setTimeout(()=>els.toast.style.display='none', ms); }
    function rampVolume(el, to, ms){ return new Promise(res=>{ const from=el.volume, st=performance.now(); (function step(n){ const t=Math.min(1,(n-st)/ms); el.volume = from + (to-from)*t; if(t<1) requestAnimationFrame(step); else res(); })(st); });}
    function setDim(){ document.documentElement.style.setProperty('--dim', els.dimSlider.value); }

    // ===== Media map =====
    const THEME_MEDIA = {
      ocean:     { webm:'media/ocean.webm',     mp4:'media/ocean.mp4',     glow:'rgba(56,189,248,0.35)' },
      fireplace: { webm:'media/fireplace.webm', mp4:'media/fireplace.mp4', glow:'rgba(251,146,60,0.35)' },
      waterfall: { webm:'media/waterfall.webm', mp4:'media/waterfall.mp4', glow:'rgba(45,212,191,0.35)' }
    };
    const PREFS = { theme:'ms.theme', video:'ms.video', dim:'ms.dim', scene:'ms.sceneAudio', sceneVol:'ms.sceneVol' };

    function loadPrefs(){
      els.selTheme.value = localStorage.getItem(PREFS.theme) || 'ocean';
      els.chkVideo.checked = localStorage.getItem(PREFS.video) !== '0';
      els.dimSlider.value = localStorage.getItem(PREFS.dim) ?? '0.5'; setDim();
      els.chkSceneAudio.checked = (localStorage.getItem(PREFS.scene) ?? '1') === '1';
      els.volScene.value = localStorage.getItem(PREFS.sceneVol) ?? '0.5';
    }
    function savePrefs(){
      localStorage.setItem(PREFS.theme, els.selTheme.value);
      localStorage.setItem(PREFS.video, els.chkVideo.checked ? '1':'0');
      localStorage.setItem(PREFS.dim, String(els.dimSlider.value));
      localStorage.setItem(PREFS.scene, els.chkSceneAudio.checked ? '1':'0');
      localStorage.setItem(PREFS.sceneVol, String(els.volScene.value));
    }

    // ===== Dual-video gapless player =====
    let active = 'A';
    function otherTag(){ return active==='A' ? els.bgB : els.bgA; }
    function activeTag(){ return active==='A' ? els.bgA : els.bgB; }

    function attachSources(el, theme){
      const m = THEME_MEDIA[theme]; if(!m) return;
      const bust = `?v=30&t=${Date.now()}`;
      el.src = ''; // reset first
      // prefer WEBM, fallback to MP4 on error
      el.innerHTML = ''; // ensure clean
      const s1 = document.createElement('source'); s1.type='video/webm'; s1.src=m.webm+bust;
      const s2 = document.createElement('source'); s2.type='video/mp4';  s2.src=m.mp4+bust;
      el.appendChild(s1); el.appendChild(s2);
      el.load();
    }

    async function applyTheme(){
      const theme = els.selTheme.value;
      localStorage.setItem(PREFS.theme, theme);
      if(!els.chkVideo.checked || theme==='none'){
        [els.bgA, els.bgB].forEach(v=>{ v.pause(); v.style.opacity=0; });
        return;
      }
      const m = THEME_MEDIA[theme]; if(!m) return;

      document.documentElement.style.setProperty('--glow', m.glow);
      els.glow.classList.remove('glow-active'); void els.glow.offsetWidth; els.glow.classList.add('glow-active');

      const cur = activeTag();
      const nxt = otherTag();

      // Prepare next
      nxt.muted = !els.chkSceneAudio.checked; // start muted state
      nxt.volume = parseFloat(els.volScene.value||'0.5');
      attachSources(nxt, theme);

      // Wait until next can play
      const ready = new Promise((resolve)=>{
        const onOk = ()=>{ cleanup(); resolve(); };
        const onErr = ()=>{ cleanup(); resolve(); }; // resolve anyway; fallback source likely loaded
        function cleanup(){ nxt.removeEventListener('loadeddata', onOk); nxt.removeEventListener('canplay', onOk); nxt.removeEventListener('error', onErr); }
        nxt.addEventListener('loadeddata', onOk, { once:true });
        nxt.addEventListener('canplay', onOk, { once:true });
        nxt.addEventListener('error', onErr, { once:true });
      });
      await ready;

      try{ await nxt.play(); }catch{ /* mobile will start after gesture */ }
      // Crossfade
      nxt.style.opacity = 1;
      cur.style.opacity = 0;
      setTimeout(()=>{ cur.pause(); cur.currentTime = 0; }, 450);
      active = (active==='A'?'B':'A');

      // Setup gapless scheduler for the now-active tag
      setupGaplessLoop(activeTag(), otherTag(), theme);
      showToast(`Theme: ${theme.charAt(0).toUpperCase()+theme.slice(1)}`, 800);
    }

    function setupGaplessLoop(main, spare, theme){
      // Clear previous listeners
      main.onended = null; spare.onended = null;
      main.ontimeupdate = null; spare.ontimeupdate = null;

      const threshold = 0.25; // seconds before end to start spare
      const vol = parseFloat(els.volScene.value||'0.5');

      function primeSpare(){
        attachSources(spare, theme);
        spare.muted = main.muted;
        spare.volume = vol;
      }
      primeSpare();

      main.loop = false; spare.loop = false;
      main.addEventListener('timeupdate', async ()=>{
        if(!isFinite(main.duration) || main.duration===0) return;
        const remaining = main.duration - main.currentTime;
        if(remaining <= threshold && spare.paused){
          try{ await spare.play(); }catch{}
          // tiny crossfade to avoid click
          spare.style.opacity = 1;
          main.style.opacity = 0;
          setTimeout(()=>{
            main.pause();
            main.currentTime = 0;
            // swap roles
            const tmp = main.src; // not used, but keep symmetry
            setupGaplessLoop(spare, main, theme);
          }, 250);
        }
      });
    }

    // Global audio controls
    function syncAudioFlags(){
      const muted = !els.chkSceneAudio.checked;
      const vol = parseFloat(els.volScene.value||'0.5');
      [els.bgA, els.bgB].forEach(v=>{ v.muted = muted; v.volume = vol; });
    }

    // ===== Beeps/Voice/Vibrate + Breathing engine (unchanged from v29) =====
    let audioCtx=null;
    function ensureAudio(){ try{ if(!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)(); if(audioCtx.state==='suspended') audioCtx.resume(); }catch{} }
    function beep(freq=880, ms=120, gain=0.05){
      if(!els.chkBeeps.checked) return;
      ensureAudio(); if(!audioCtx) return;
      const o = audioCtx.createOscillator(); const g = audioCtx.createGain();
      o.frequency.value=freq; o.type='sine'; const t0=audioCtx.currentTime;
      g.gain.setValueAtTime(0,t0); g.gain.linearRampToValueAtTime(gain,t0+0.01); g.gain.exponentialRampToValueAtTime(0.0001,t0+ms/1000);
      o.connect(g).connect(audioCtx.destination); o.start(); o.stop(t0+ms/1000+0.02);
    }
    function speak(text){ if(!els.chkVoice.checked) return; try{ speechSynthesis.cancel(); const u=new SpeechSynthesisUtterance(text); u.rate=1.05; u.pitch=1; u.volume=1; speechSynthesis.speak(u);}catch{} }
    function vibrate(ms=25){ if(els.chkVibrate.checked && navigator.vibrate) navigator.vibrate(ms); }

    const PRESET_STORAGE_KEY = 'ms.preset';
    function updateValLabels(){ vIn.textContent=rIn.value; vH1.textContent=rH1.value; vEx.textContent=rEx.value; vH2.textContent=rH2.value; }
    ['input','change'].forEach(evt=>{
      [rIn,rH1,rEx,rH2].forEach(r=>r.addEventListener(evt, updateValLabels));
      [rIn,rH1,rEx,rH2,els.cycles,els.rounds].forEach(ctrl=>ctrl.addEventListener(evt, ()=>{
        [...els.presets.children].forEach(c=>c.classList.remove('active'));
        try{ localStorage.setItem(PRESET_STORAGE_KEY, JSON.stringify({name:'Custom', inhale:+rIn.value, hold1:+rH1.value, exhale:+rEx.value, hold2:+rH2.value, cycles:+els.cycles.value, rounds:+els.rounds.value})); }catch{}
      }));
    });
    function applyPreset(p){
      if(p.inhale!=null) rIn.value=p.inhale; if(p.hold1!=null) rH1.value=p.hold1; if(p.exhale!=null) rEx.value=p.exhale; if(p.hold2!=null) rH2.value=p.hold2;
      if(p.cycles!=null) els.cycles.value=p.cycles; if(p.rounds!=null) els.rounds.value=p.rounds; updateValLabels(); showToast(p.name||'Preset',700);
    }
    function loadPreset(){ try{ const raw=localStorage.getItem(PRESET_STORAGE_KEY); if(raw){ const p=JSON.parse(raw); applyPreset(p); [...els.presets.children].forEach(c=>{ const d=JSON.parse(c.dataset.preset); if(d.name===p.name && p.name!=='Custom'){ c.classList.add('active'); }});} else { updateValLabels(); } }catch{ updateValLabels(); } }
    if (els.presets){
      els.presets.addEventListener('click', (e)=>{
        const chip=e.target.closest('.chip'); if(!chip) return; [...els.presets.children].forEach(c=>c.classList.remove('active')); chip.classList.add('active');
        const p=JSON.parse(chip.dataset.preset); if(p.name==='Custom'){ try{ localStorage.setItem(PRESET_STORAGE_KEY, JSON.stringify({name:'Custom', inhale:+rIn.value, hold1:+rH1.value, exhale:+rEx.value, hold2:+rH2.value, cycles:+els.cycles.value, rounds:+els.rounds.value})); }catch{} } else { applyPreset(p); try{ localStorage.setItem(PRESET_STORAGE_KEY, JSON.stringify(p)); }catch{} }
      });
    }

    // Breathing engine
    let running=false, paused=false, round=0, cycle=0, phaseIndex=0, phaseTimeLeft=0, interval=null, lastSecond=-1;
    const phasesBase=[{key:'inhale',label:'Inhale'},{key:'hold1',label:'Hold'},{key:'exhale',label:'Exhale'},{key:'hold2',label:'Hold'}];
    function seq(){ const arr=[+rIn.value,+rH1.value,+rEx.value,+rH2.value]; return arr.map((v,i)=>({dur:Math.max(0,v),...phasesBase[i]})).filter(p=>p.dur>0); }
    function updateHUD(label,count){ document.getElementById('phase').textContent=label; document.getElementById('counter').textContent=count; document.getElementById('roundsHint').textContent=`Rounds: ${round||0} • Cycle: ${cycle||0}`; }
    function onPhaseStart(nxt){ lastSecond=-1; vibrate(30); if(els.chkBeeps.checked){ beep(660,120,0.06); setTimeout(()=>beep(880,100,0.05),110);} if(els.chkVoice.checked){ speak(nxt.label); } }
    function perSecondCue(secLeft){ if(secLeft!==lastSecond){ lastSecond=secLeft; if(els.chkBeeps.checked) beep(800,90,0.04); if(els.chkVoice.checked && secLeft<=3 && secLeft>0){ speak(String(secLeft)); } } }
    function tick(){ const s=seq(); if(!s.length) return; const cur=s[phaseIndex%s.length]; if(!paused){ phaseTimeLeft-=0.2; const d=Math.max(0,Math.ceil(phaseTimeLeft)); perSecondCue(d); if(phaseTimeLeft<=0){ phaseIndex++; if(phaseIndex%s.length===0){ cycle++; if(cycle>+els.cycles.value){ round++; if(round>+els.rounds.value){ stop(); return;} cycle=1; } } const nxt=s[phaseIndex%s.length]; phaseTimeLeft=nxt.dur; onPhaseStart(nxt); updateHUD(nxt.label,Math.ceil(phaseTimeLeft)); } else { updateHUD(cur.label,d);} } else { const d=Math.max(0,Math.ceil(phaseTimeLeft)); updateHUD(cur.label,d);} }
    function start(){ if(running) return; running=true; paused=false; round=1; cycle=1; phaseIndex=0; const s=seq(); phaseTimeLeft=s[0].dur; onPhaseStart(s[0]); updateHUD(s[0].label,Math.ceil(phaseTimeLeft)); interval=setInterval(tick,200); btnStart.disabled=true; btnPause.disabled=false; btnStop.disabled=false; }
    function pause(){ if(!running) return; paused=!paused; btnPause.textContent=paused?'▶ Resume':'⏸️ Pause'; }
    function stop(){ running=false; paused=false; clearInterval(interval); btnStart.disabled=false; btnPause.disabled=true; btnStop.disabled=true; btnPause.textContent='⏸️ Pause'; updateHUD('Ready',0); speechSynthesis?.cancel(); }
    btnStart.addEventListener('click', start); btnPause.addEventListener('click', pause); btnStop.addEventListener('click', stop); btnReset.addEventListener('click', ()=>{ if(!running){ round=0; cycle=0; phaseIndex=0; phaseTimeLeft=0; updateHUD('Ready',0); }});

    // Session timer
    let tRun=false,tPause=false,tInt=null,tMs=0,tSet=0,tMode='work';
    function fmt(ms){const s=Math.max(0,Math.ceil(ms/1000));const m=Math.floor(s/60);const ss=String(s%60).padStart(2,'0');return `${String(m).padStart(2,'0')}:${ss}`;}
    function updTimer(){ let pill=document.getElementById('timerPill'); if(!pill){ pill=document.createElement('div'); pill.id='timerPill'; pill.style.cssText='position:fixed;top:10px;right:10px;background:rgba(0,0,0,.35);border:1px solid rgba(255,255,255,.2);padding:6px 10px;border-radius:999px;font-variant-numeric:tabular-nums;z-index:2'; document.body.appendChild(pill);} pill.textContent=`⏱ ${fmt(tMs)} (Set ${tSet+1}/${+timerSets.value}${tMode==='rest'?' • Rest':''})`; }
    function timerStart(){ if(tRun) return; tRun=true; tPause=false; tMode='work'; tSet=0; tMs=+timerMinutes.value*60*1000; btnTimerPause.disabled=false; btnTimerStop.disabled=false; updTimer(); tInt=setInterval(()=>{ if(!tRun||tPause) return; tMs-=200; if(tMs<=0){ const total=+timerSets.value; if(tMode==='work'){ const rest=+timerRest.value; if(rest>0){ tMode='rest'; tMs=rest*60*1000; } else { tSet++; if(tSet>=total){ return timerStop(true);} tMode='work'; tMs=+timerMinutes.value*60*1000; } } else { tSet++; if(tSet>=total){ return timerStop(true);} tMode='work'; tMs=+timerMinutes.value*60*1000; } } updTimer(); },200); }
    function timerPause(){ if(!tRun) return; tPause=!tPause; btnTimerPause.textContent=tPause?'Resume':'Pause'; }
    function timerStop(){ tRun=false; tPause=false; clearInterval(tInt); btnTimerPause.textContent='Pause'; btnTimerPause.disabled=true; btnTimerStop.disabled=true; const pill=document.getElementById('timerPill'); if(pill) pill.remove(); }
    btnTimerStart.addEventListener('click', timerStart); btnTimerPause.addEventListener('click', timerPause); btnTimerStop.addEventListener('click', timerStop);

    // ===== Wiring & Init =====
    function firstGestureInit(){
      // Unmute if allowed and play
      syncAudioFlags();
      [els.bgA, els.bgB].forEach(v=>{ v.play().catch(()=>{}); });
      document.removeEventListener('pointerup', firstGestureInit);
      document.removeEventListener('touchend', firstGestureInit);
      document.removeEventListener('click', firstGestureInit);
    }
    loadPrefs();
    setDim();
    loadPreset();
    applyTheme();
    // Controls
    els.dimSlider.addEventListener('input', ()=>{ setDim(); savePrefs(); });
    els.volScene.addEventListener('input', ()=>{ syncAudioFlags(); savePrefs(); });
    els.chkSceneAudio.addEventListener('change', ()=>{ syncAudioFlags(); savePrefs(); });
    els.selTheme.addEventListener('change', ()=>{ applyTheme(); });
    els.chkVideo.addEventListener('change', ()=>{ applyTheme(); });
    document.addEventListener('pointerup', firstGestureInit, { passive:true });
    document.addEventListener('touchend', firstGestureInit, { passive:true });
    document.addEventListener('click', firstGestureInit, { passive:true });
    document.addEventListener('visibilitychange', ()=>{ if(!document.hidden){ syncAudioFlags(); [els.bgA,els.bgB].forEach(v=>v.play().catch(()=>{})); } });
  })();
  </script>
</body>
</html>
